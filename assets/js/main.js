var D=Object.defineProperty;var O=(n,e,t)=>e in n?D(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var r=(n,e,t)=>O(n,typeof e!="symbol"?e+"":e,t);var g=(n=>(n.Up="ArrowUp",n.Right="ArrowRight",n.Down="ArrowDown",n.Left="ArrowLeft",n))(g||{});const M={2:"level-0",4:"level-1",8:"level-2",16:"level-3",32:"level-4",64:"level-5",128:"level-6",256:"level-7",512:"level-8",1024:"level-9",2048:"level-10",4096:"level-11",8192:"level-12"};class v{constructor(e,t,s=0){r(this,"el");r(this,"valueEl");r(this,"_value",0);r(this,"noMerge",!1);r(this,"animationPromise");this.x=e,this.y=t,this.el=this.createDivElement(["cell"]),this.valueEl=this.createDivElement(["cell__value"]),this.el.append(this.valueEl),this._value=s}set value(e){this.noMerge||(this._value=e,this.render())}get value(){return this._value}denyMerge(){this.noMerge=!0}allowMerge(){this.noMerge=!1}isNoMerge(){return this.noMerge}async render(){await this.animationPromise,this.valueEl.textContent=this.isEmpty()?"":this._value.toString(),this.updateStyle()}updateStyle(){const e=this.valueEl;if(Array.from(e.classList).filter(t=>t.startsWith("level-")).forEach(t=>e.classList.remove(t)),!this.isEmpty()){const t=M[this._value]??M[8192];e.classList.add(t)}}isEmpty(){return this._value===0}createDivElement(e=null){const t=document.createElement("div");return e&&t.classList.add(...e),t}rollDice(e){this.playAppearAnimation(),this.value=e}merge(){this.playMergeAnimation(),this.value*=2}back(e=this.value){this.playBackAnimation(),this.value=e}reset(){this._value=0,this.render()}async playAnimation(e){await this.animationPromise,this.valueEl.classList.add(e);const t=()=>{this.valueEl.classList.remove(e)};this.valueEl.addEventListener("animationend",t)}playMergeAnimation(){return this.playAnimation("merge")}playAppearAnimation(){return this.playAnimation("apear")}playBackAnimation(){return this.playAnimation("back")}addAnimationPromise(e){this.animationPromise=e}toDTO(){return{x:this.x,y:this.y,value:this._value}}static fromDTO({x:e,y:t,value:s}){return new v(e,t,s)}}class q{constructor(){}static setRootVariables(e){Object.entries(e).forEach(([t,s])=>{document.documentElement.style.setProperty(t.startsWith("--")?t:`--${t}`,s)})}static getRootCSSVariable(e){return getComputedStyle(document.documentElement).getPropertyValue(e.startsWith("--")?e:`--${e}`)}}const N=.9;class m{constructor(e,t){r(this,"size",4);r(this,"_fields");r(this,"boardDirection");this.elBoard=t,this.size=e,q.setRootVariables({"board-size":this.size.toString()}),this.fields=new Array(this.size).fill([]).reduce((s,i,a)=>{s[a]=[];for(let o=0;o<this.size;o++){const l=new v(a,o);s[a][o]=l,t.append(l.el)}return s},[]),this.fields[0][0].value=1024,this.fields[0][1].value=1024}get fields(){return this._fields}set fields(e){this._fields=e,this.boardDirection={left:this.fields,right:this.fields.map(t=>[...t].reverse()),up:this.fields[0].map((t,s)=>this.fields.map(i=>i[s])),down:this.fields[0].map((t,s)=>[...this.fields].reverse().map(i=>i[s]))}}addNewValue(){const e=this.fields.flat().filter(i=>i.isEmpty());if(e.length===0)return;const t=e[Math.floor(Math.random()*e.length)],s=Math.random()<N?2:4;t.rollDice(s)}static toDTO(e){return e.map(t=>t.map(s=>s.toDTO()))}static fromDTO(e){return e.map(t=>t.map(s=>v.fromDTO(s)))}}class x{constructor(e,t,s){r(this,"mergedCells",new Set);r(this,"wasMove",!1);r(this,"move",async e=>{this.gameManager.saveGame({op:"start",fields:this.board.fields,direction:e});const t=this.board.boardDirection[e];for(let s=0;s<this.board.size;s++){let i=null;const a=new Promise(o=>{i=o});for(let o=0;o<this.board.size;o++){const l=t[s][o];l.addAnimationPromise(a),l.isEmpty()||(o=this.moveCell(t,l,s,o))}this.animationManager.run(e),this.animationManager.wait().then(()=>{i&&i()})}this.wasMove&&(await this.animationManager.wait(),this.board.addNewValue(),this.gameManager.checkGame(),this.gameManager.checkWin(this.mergedCells),this.wasMove=!1,this.gameManager.addScore(this.mergedCells),this.gameManager.saveGame({op:"end",mergedCells:this.mergedCells})),this.resetFreezeCells(),this.mergedCells.clear()});this.board=e,this.gameManager=t,this.animationManager=s}moveCell(e,t,s,i){if(i===0)return i;const a=e[s][i-1],o=t.value;return a.isEmpty()?(this.animationManager.addCell(t),t.value=0,a.value=o,t.isNoMerge()&&(t.allowMerge(),a.denyMerge()),this.wasMove=!0,i-2):a.value===o&&!a.isNoMerge()&&!t.isNoMerge()?(this.animationManager.addCell(t),t.value=0,a.merge(),a.denyMerge(),this.mergedCells.add(a),this.wasMove=!0,i-2):i}resetFreezeCells(){this.mergedCells.forEach(e=>e.allowMerge())}}const w="User";class I{constructor(e,t={}){r(this,"baseUrl");r(this,"defaultHeaders");this.baseUrl=e,this.defaultHeaders={"Content-Type":"application/json",...t}}async request(e,t={}){const{method:s="GET",headers:i={},body:a,params:o,credentials:l="same-origin",mode:c,cache:p}=t,f=new URL(this.baseUrl+e);o&&Object.entries(o).forEach(([h,d])=>{d!=null&&f.searchParams.append(h,String(d))});const S={method:s,headers:{...this.defaultHeaders,...i},credentials:l,mode:c,cache:p};a&&s!=="GET"&&(S.body=typeof a=="object"?JSON.stringify(a):a);try{const h=await fetch(f.toString(),S);let d=null;const b=h.headers.get("content-type");return b&&b.includes("application/json")?d=await h.json():h.status!==204&&(d=await h.text()),{data:d,status:h.status,statusText:h.statusText,headers:h.headers,ok:h.ok}}catch(h){throw console.error("API request failed:",h),h}}async get(e,t,s={}){return this.request(e,{...s,method:"GET",params:t})}async post(e,t,s={}){return this.request(e,{...s,method:"POST",body:t})}async put(e,t,s={}){return this.request(e,{...s,method:"PUT",body:t})}async patch(e,t,s={}){return this.request(e,{...s,method:"PATCH",body:t})}async delete(e,t={}){return this.request(e,{...t,method:"DELETE"})}setDefaultHeaders(e){this.defaultHeaders={...this.defaultHeaders,...e}}}class C{constructor(e="local"){r(this,"storage");this.storage=e==="local"?localStorage:sessionStorage}set(e,t,s=null){try{const i={value:t,expires:s?Date.now()+s*1e3:null};return this.storage.setItem(e,JSON.stringify(i)),!0}catch{return console.error("StorageService [set]: ошибка"),!1}}get(e,t=null){try{const s=this.storage.getItem(e);if(!s)return t;const i=JSON.parse(s);return i.expires&&Date.now()>i.expires?(this.remove(e),t):i.value}catch(s){return console.error("StorageService [get]: ошибка",s),t}}remove(e){this.storage.removeItem(e)}has(e){return this.storage.getItem(e)!==null}clear(){this.storage.clear()}}class F{constructor(e,t){r(this,"el");switch(this.el=document.createElement("li"),this.el.textContent=e,t){case"warn":this.el.classList.add("warn");break;case"info":this.el.classList.add("info");break}this.el.classList.add("message-item")}}const u=class u{constructor(){r(this,"messageList",[]);r(this,"timeOut",3e3);r(this,"messageId",0);r(this,"messageListEl",document.querySelector("#message-list"))}static getInstance(){return u.instance||(u.instance=new u),u.instance}create(e,t,s=!0){var o;const i=new F(e,t),a=this.messageId;this.messageList.push({id:a,text:e}),(o=this.messageListEl)==null||o.append(i.el),i.el.classList.add("active"),s&&setTimeout(()=>{const l=c=>{c.animationName==="fadeOut"&&(i.el.removeEventListener("animationend",l),i.el.remove())};this.messageList=this.messageList.filter(c=>c.id!==a),i.el.addEventListener("animationend",l),i.el.classList.add("end"),i.el.classList.remove("active")},this.timeOut)}};r(u,"instance");let E=u;class P{constructor(){r(this,"_userName",w);r(this,"startTime",null);r(this,"_id",null);r(this,"scoreList");r(this,"apiCliend",new I("http://localhost:3000/api/v1"));r(this,"storageServie",new C);r(this,"processingStart",!1);r(this,"ttl",3600*24*7);r(this,"userNameEl",document.querySelector("#username"));r(this,"scoreListEl",document.querySelector("#body-record"));r(this,"messages",E.getInstance());this.getAll()}set userName(e){this._userName=e,this.userNameEl&&(this.userNameEl.textContent=e)}get userName(){return this._userName}restart(){this.reset(),this.start()}async start(){if(this.getInLocal(),!(this.startTime||this.processingStart))try{this.processingStart=!0;const e={username:this._userName},t=await this.apiCliend.post("/score/",e);if(this.processingStart=!1,t.ok&&t.data){const{username:s,_id:i,startTime:a}=t.data;if(!a||!i){this.messages.create("Ошибка соединения. Рекорд не будет зафиксирован","warn");return}this.startTime=a,this._id=i,this.userName=s,this.saveStore(),this.messages.create("Игра начата","info")}}catch(e){this.messages.create("Ошибка соединения. Рекорд не будет зафиксирован","warn"),this.processingStart=!1,console.error("start: ",e)}}async end(){if(!this._id||!this.startTime){this.messages.create("Ошибка, рекорд не зафиксирован(","warn");return}try{const e={startTime:this.startTime};(await this.apiCliend.patch(`/score/${this._id}`,e)).ok&&(this.getAll(),this.reset(),this.messages.create("Рекорд зафиксирован. Время прохождения:","info"))}catch(e){this.messages.create("Ошибка, рекорд не зафиксирован(","warn"),console.error("End:",e)}}async getAll(){try{const e=await this.apiCliend.get("/score/");e.ok&&e.data&&(this.scoreList=e.data,this.render())}catch(e){console.error("All:",e)}}async reset(){this.startTime=null,this._id=null,this.storageServie.remove("_id"),this.storageServie.remove("startTime")}getInLocal(){const e=this.storageServie.get("_id"),t=this.storageServie.get("startTime"),s=this.storageServie.get("username");this._id=e??null,this.startTime=t??null,this.userName=s??w}saveStore(){this.storageServie.set("_id",this._id,this.ttl),this.storageServie.set("username",this.userName,this.ttl),this.storageServie.set("startTime",this.startTime,this.ttl)}formatLongDuration(e){const t=Math.floor(e/1e3)%60,s=Math.floor(e/(1e3*60))%60,i=Math.floor(e/(1e3*60*60))%24,a=Math.floor(e/(1e3*60*60*24)),o=[];return a>0&&o.push(`${a} дн.`),i>0&&o.push(`${i} ч.`),s>0&&o.push(`${s} мин.`),t>0&&o.push(`${t} сек.`),o.join(" ")||"0 сек."}render(){this.scoreListEl&&(this.scoreListEl.textContent="",this.scoreList.sort((e,t)=>e.duration-t.duration).forEach((e,t)=>{var p;const{duration:s,username:i}=e,a=document.createElement("tr");a.classList.add("top-record");const o=document.createElement("td");o.classList.add("top-record__rank"),o.textContent=(t+1).toString();const l=document.createElement("td");l.classList.add("top-record__name"),l.textContent=i;const c=document.createElement("td");c.classList.add("top-record__score"),c.textContent=this.formatLongDuration(s),[o,l,c].forEach(f=>{a.append(f)}),(p=this.scoreListEl)==null||p.append(a)}))}}class R{constructor(e,t,s,i,a){r(this,"startY");r(this,"step",0);r(this,"maxSteps",5);r(this,"state",[]);r(this,"gameMessageEl",document.querySelector(".game-message"));r(this,"gameWinEl",document.querySelector(".game-win"));r(this,"recordManager",new P);r(this,"gameContinueEl",document.querySelector(".game-win__continue"));r(this,"gameOverEl",document.querySelector(".game-over"));r(this,"buttonBackEl",document.querySelector("button#back"));r(this,"restartEl",document.querySelector("button#restart"));r(this,"restartElms",document.querySelectorAll(".button-restart"));r(this,"flagStop",!1);r(this,"flagLoop",!1);r(this,"goBack",e=>{if(!this.state.length||!this.buttonBackEl||(e.preventDefault(),this.state[this.state.length-1].op==="start"&&(this.state.pop(),!this.state.length)))return;const{mergedCells:t,fields:s,score:i,record:a}=this.state[this.state.length-1];if(this.state.pop(),this.step=Math.max(0,this.step-1),s){const o=m.fromDTO(s);this.restoreFields(o),this.score.record=a??0,this.score.score=i??0,t==null||t.forEach(({x:l,y:c})=>{this.board.fields[l][c].back()})}if(this.saveInLocal(),!this.state.length){this.buttonBackEl.disabled=!0;return}});r(this,"restart",()=>{var e,t;this.flagLoop=!1,this.flagStop=!1,this.state=[],this.score.addScore(0),this.local.setScore("record",this.score.record),this.board.fields.forEach(s=>{s.forEach(i=>i.reset())}),(e=this.gameMessageEl)==null||e.classList.remove("active"),(t=this.gameMessageEl)==null||t.setAttribute("hidden",""),this.board.addNewValue(),this.local.clear(),this.buttonBackEl&&(this.buttonBackEl.disabled=!0),this.recordManager.restart()});r(this,"continueGame",()=>{var e,t;this.flagLoop=!0,this.flagStop=!1,(e=this.gameMessageEl)==null||e.classList.remove("active"),(t=this.gameMessageEl)==null||t.setAttribute("hidden",""),this.checkGame()});var o,l;this.local=e,this.board=t,this.boardDirection=s,this.animationManager=i,this.score=a,(o=this.buttonBackEl)==null||o.addEventListener("click",this.goBack),[this.restartEl,...this.restartElms].forEach(c=>c==null?void 0:c.addEventListener("click",this.restart)),(l=this.gameContinueEl)==null||l.addEventListener("click",this.continueGame),this.getInLocal(),this.recordManager.start()}saveGame(e){switch(e.op){case"start":const{direction:t,fields:s,op:i}=e;this.state[this.step]={direction:t,fields:m.toDTO(s),op:i},this.state[this.step].score=this.score.score,this.state[this.step].record=this.score.record;break;case"end":const{mergedCells:a}=e;if(!this.state[this.step])break;for(this.state[this.step].mergedCells=Array.from(a).map(l=>l.toDTO()),this.state[this.step].op=e.op,this.step++;this.state.length>this.maxSteps;)this.state.shift(),this.step=Math.max(0,this.step-1);this.saveInLocal(),this.state.length&&this.buttonBackEl&&(this.buttonBackEl.disabled=!1);break;default:return e}}checkGame(){for(const[e,t]of Object.entries(this.boardDirection))for(const s of t)for(let i=0;i<s.length;i++){const a=s[i].value;if(a===0||i>0&&s[i-1].value===a)return!1}return this.gameOver(),!0}checkWin(e){return e.forEach(t=>{if(t.value>=2048&&!this.flagLoop)return this.gameWin(),!0}),!1}async gameOver(){var e,t,s,i;this.flagStop=!0,await this.animationManager.wait(),(e=this.gameOverEl)==null||e.classList.add("active"),(t=this.gameWinEl)==null||t.classList.remove("active"),(s=this.gameMessageEl)==null||s.classList.add("active"),(i=this.gameMessageEl)==null||i.removeAttribute("hidden")}async gameWin(){var e,t,s,i;this.flagStop=!0,await this.animationManager.wait(),(e=this.gameOverEl)==null||e.classList.remove("active"),(t=this.gameWinEl)==null||t.classList.add("active"),(s=this.gameMessageEl)==null||s.classList.add("active"),(i=this.gameMessageEl)==null||i.removeAttribute("hidden"),this.recordManager.end()}isStop(){return this.flagStop}addScore(e){e.forEach(t=>{this.score.addScore(t.value)})}async saveInLocal(){await this.animationManager.wait(),this.local.setFields(m.toDTO(this.board.fields)),this.local.setScore("score",this.score.score),this.local.setScore("record",this.score.record)}getInLocal(){const e=this.local.getScore("score"),t=this.local.getScore("record");this.score.record=t??0;const s=this.local.getFields();if(!s)return;const i=m.fromDTO(s);this.restoreFields(i),this.score.score=e??0}restoreFields(e){const t=m.fromDTO(e);this.board.fields=t,this.board.elBoard.textContent="",this.board.fields.forEach(s=>s.forEach(i=>{this.board.elBoard.append(i.el),i.value=i.value}))}}class y{constructor(e,t,s){r(this,"animationId",null);r(this,"startTime",0);r(this,"lastFrameTime",0);r(this,"isRunning",!1);r(this,"resolvePromise",null);r(this,"promise");this.callback=e,this.duration=t,this.doAfter=s}start(){return this.isRunning?Promise.reject(new Error("уже запущена")):(this.isRunning=!0,this.startTime=performance.now(),this.lastFrameTime=this.startTime,this.promise=new Promise(e=>{this.resolvePromise=e,this.animationId=requestAnimationFrame(this.loop.bind(this))}),this.promise)}stop(){var e,t;this.isRunning&&(this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.isRunning=!1,(e=this.resolvePromise)==null||e.call(this),this.resolvePromise=null,(t=this.promise)==null||t.then(()=>{this.doAfter&&this.doAfter()}))}loop(e){if(!this.isRunning)return;const t=e-this.startTime,s=Math.min(t/this.duration,1),i=e-this.lastFrameTime;this.lastFrameTime=e,this.callback(s,i),s<1?this.animationId=requestAnimationFrame(this.loop.bind(this)):this.stop()}get running(){return this.isRunning}}const V=(n,e)=>t=>{e.forEach(s=>{let i,a,o=100*t;switch(n){case"up":[i,a]=[0,-o];break;case"right":[i,a]=[o,0];break;case"down":[i,a]=[0,o];break;case"left":[i,a]=[-o,0];break}s.valueEl.style.transform=`translate(${i}%, ${a}%)`})},B=n=>()=>{n.forEach(e=>{e.valueEl.style.transform="translate(0, 0)"}),n.clear()};class U{constructor(){r(this,"activeAnimations",[]);r(this,"needAnimation",new Set)}async runAnimation(e,t,s){const a=new y(e,t,s).start();a&&(this.activeAnimations.push(a),a.finally(()=>{this.activeAnimations=this.activeAnimations.filter(o=>o!==a)}))}async run(e){return this.runAnimation(V(e,this.needAnimation),100,B(this.needAnimation))}async wait(){return Promise.all(this.activeAnimations)}get isAnimating(){return this.activeAnimations.length>0}addCell(e){this.needAnimation.add(e)}}const L=(n,e,t,s)=>i=>{const a=Math.floor(n+(e-n)*i);t.textContent=a.toString(),t.classList.add(s)},A=(n,e)=>()=>{n.classList.remove(e)};var k,_;class G{constructor(){r(this,"_score",0);r(this,"_record",0);r(this,"scoreEl",document.querySelector("#score"));r(this,"recordEl",document.querySelector("#record"));r(this,"scoreValueEl",(k=this.scoreEl)==null?void 0:k.querySelector(".score__value"));r(this,"recordValueEl",(_=this.recordEl)==null?void 0:_.querySelector(".score__value"));r(this,"duration",400)}addScore(e){switch(e){case 0:this.score=0;break;default:this.score+=e}}addRecord(e){switch(e){case 0:this.record=0;break;default:this.record+=e}}set score(e){const t=this._score;if(this._score=e,this._score>this.record&&(this.record=e),!this.scoreValueEl)return;const s=this.getAnimationClassName(e,t);new y(L(t,e,this.scoreValueEl,s),this.duration,A(this.scoreValueEl,s)).start()}get score(){return this._score}set record(e){const t=this._record;if(this._record=e,!this.recordValueEl)return;const s=this.getAnimationClassName(e,t);new y(L(t,e,this.recordValueEl,s),this.duration,A(this.recordValueEl,s)).start()}get record(){return this._record}getAnimationClassName(e,t){return e-t<0?"negative":"positive"}}class z{constructor(){r(this,"storage",new C);r(this,"ttl",3600*24*7)}setScore(e,t){this.storage.set(e,t,this.ttl)}getScore(e){return this.storage.get(e)}setFields(e){this.storage.set("fields",e,this.ttl)}getFields(){return this.storage.get("fields")}clear(){this.storage.remove("score"),this.storage.remove("fields")}}class W{constructor(e){r(this,"startX");r(this,"startY");r(this,"minMouseDiff",12);r(this,"g2048El",document.querySelector("#game2048 .game2048__board"));r(this,"local");r(this,"board");r(this,"movement");r(this,"gameManager");r(this,"animationManager");r(this,"score");r(this,"pointerUp",e=>{const t=e.pageX-this.startX,s=e.pageY-this.startY;Math.abs(s)>Math.abs(t)&&Math.abs(s)>=this.minMouseDiff?this.movement.move(s<0?"up":"down"):Math.abs(t)>=this.minMouseDiff&&this.movement.move(t<0?"left":"right"),document.removeEventListener("pointerup",this.pointerUp)});this.gameParams=e,this.g2048El&&(this.local=new z,this.score=new G,this.animationManager=new U,this.board=new m(e.boardSize,this.g2048El),this.gameManager=new R(this.local,this.board,this.board.boardDirection,this.animationManager,this.score),this.movement=new x(this.board,this.gameManager,this.animationManager),this.keyEventListeners(),this.mouseMoveEventListeners())}keyEventListeners(){document.addEventListener("keydown",e=>{if(this.animationManager.isAnimating||this.gameManager.isStop())return;e.preventDefault();const t=e.key;switch(t){case g.Up:this.movement.move("up");break;case g.Right:this.movement.move("right");break;case g.Down:this.movement.move("down");break;case g.Left:this.movement.move("left");break;default:return t}})}mouseMoveEventListeners(){this.board.elBoard.addEventListener("pointerdown",e=>{this.animationManager.isAnimating||this.gameManager.isStop()||(this.startX=e.pageX,this.startY=e.pageY,e.preventDefault(),document.addEventListener("pointerup",this.pointerUp))})}}class T{constructor(e){r(this,"overlay");r(this,"popup");r(this,"options");if(this.options={overlayClose:!0,closeButtonSelector:".popup-close",...e},this.popup=document.querySelector(this.options.popupSelector),!this.popup){console.warn("Попап не найден: ",this.options.popupSelector);return}this.overlay=this.popup.closest(".popup-overlay"),this.init()}init(){var e;if(this.options.overlayClose&&this.overlay.addEventListener("click",t=>{t.target===this.overlay&&this.close()}),this.options.closeButtonSelector){const t=(e=this.popup)==null?void 0:e.querySelector(this.options.closeButtonSelector);t&&t.addEventListener("click",()=>this.close())}this.overlay.hidden=!0}open(){this.overlay.hidden=!1,this.overlay.style.pointerEvents="auto",setTimeout(()=>{var e;this.overlay.classList.add("active"),(e=this.popup)==null||e.classList.add("active")},10),this.options.onOpen&&this.options.onOpen()}close(){var e;this.overlay.classList.remove("active"),(e=this.popup)==null||e.classList.remove("active"),setTimeout(()=>{this.overlay.hidden=!0,this.overlay.style.pointerEvents="none",this.options.onClose&&this.options.onClose()},300)}}const $=new T({popupSelector:"#popup-rules",overlayClose:!0}),Y=()=>{document.querySelectorAll(".open-popup-instructions").forEach(n=>n.addEventListener("click",()=>{$.open()}))},j=new T({popupSelector:"#popup-record",overlayClose:!0}),H=()=>{document.querySelectorAll(".open-popup-records").forEach(n=>n.addEventListener("click",()=>{j.open()}))};document.addEventListener("DOMContentLoaded",()=>{new W({boardSize:5}),Y(),H()});
